name: Minify Lua Code

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'

jobs:
  minify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install Lua
      run: |
        sudo apt-get update
        sudo apt-get install -y lua5.3

    - name: Minify Lua files
      run: |
        mkdir -p release
        
        echo "Creating minification script..."
        cat > minify_script.lua << 'EOL'
        local minify = loadfile("minify.lua")()
        local f = io.open("src/main.lua", "r")
        local content = f:read("*all")
        f:close()
        
        local success, minified = minify(content)
        
        if not success then
          print("Minification failed")
          print(minified)
          return
        end

        local out = io.open("release/main.min.lua", "w")
        out:write(minified)
        out:close()
        EOL
        
        echo "Running minification..."
        if lua minify_script.lua; then
          echo "Minification successful"
          echo "Minified content:"
          cat release/main.min.lua
        else
          echo "Minification failed"
          exit 1
        fi

    - name: Commit minified Lua file
      if: success()
      run: |
        if [ -s release/main.min.lua ]; then
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add release/main.min.lua
          git commit -m 'Minify main.lua'
          git push
        else
          echo "Error: main.min.lua is empty or doesn't exist"
          exit 1
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
